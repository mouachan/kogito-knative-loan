# kogito-knative-loan


## Deploy on openshift
- Please install : 
  - oc cli : https://docs.openshift.com/container-platform/4.5/cli_reference/openshift_cli/getting-started-cli.html
  - kn cli : https://docs.openshift.com/container-platform/4.5/serverless/installing_serverless/installing-kn.html#installing-kn
  - kogito cli : https://docs.jboss.org/kogito/release/latest/html_single/#proc-kogito-operator-and-cli-installing_kogito-deploying-on-openshift


* connect to Openshift server

  ```sh
  oc login https://ocp-url:6443 -u login -p password
  ```



* Create a new namespace
  ```sh
    export PROJECT=kogito-knative-loan
    oc new-project $PROJECT
  ```
* Install Openshift Serverless and knative-serving 

  * install openshift-serverless operator from OperatorHub

    https://docs.openshift.com/container-platform/4.6/serverless/installing_serverless/installing-openshift-serverless.html

  * create a knative-serving and knative-eventing instance
    ```sh
    ./manifest/scripts/knative-serving.sh
    ./manifest/scripts/knative-eventing.sh
    oc label namespace kogito-knative-bbank bindings.knative.dev/include=true 
    ```

  * create the knative bkoker
    ```sh
    oc apply -f manifest/services/keventing/infra/broker.yml
    ```
  * add the event-display service to follow the cloud native events 
    ```sh
    oc apply -f manifest/services/keventing/kogito-services/event-display-service.yml
    ```
  * deploy a trigger to run event-display service to log all events
   
    ```sh
    oc apply -f ../manifest/services/keventing/trigger/display-all-events-trigger
    ```
    

* Deploy kogito infra and notation service

  * install Kogito operator

  * deploy the kogito infra 
    ```sh
    cd ..
    #kogito install infra kogito-infinispan-infra --kind Infinispan --apiVersion infinispan.org/v1 --resource-name kogito-infinispan 
    oc apply -f ./manifest/services/keventing/infra/kogito-knative-infra.yml -n $PROJECT
    ```

  * deploy eligibility/notation service

    ```sh
    #create the service throw kogito operator 
    oc apply -f ./manifest/services/keventing/kogito-services/eligibility-kogitoapp.yml
    cd eligibility
    mvn clean package  -DskipTests=true
    oc start-build eligibility --from-dir=target 
    ```
    
    ```sh
    #create the service throw kogito operator 
    cd ../notation
    oc apply -f ../manifest/services/keventing/kogito-services/notation-kogitoapp.yml
    mvn clean package  -DskipTests=true
    oc start-build notation --from-dir=target 
    ```
    * get the eligibility route
    ```sh
    projects/kogito-knative-loan main ‚ùØ oc get route
        NAME          HOST/PORT                                                         PATH   SERVICES      PORT   TERMINATION   WILDCARD
        eligibility   eligibility-loan.apps.cluster-152a.152a.sandbox1775.opentlc.com          eligibility   http                 None
        loan          loan-loan.apps.cluster-152a.152a.sandbox1775.opentlc.com                 loan          http                 None
        notation      notation-loan.apps.cluster-152a.152a.sandbox1775.opentlc.com 
    ```
    * We are ready for tests, üòÜ

        * call the eligibility service
            ```sh
                curl -X POST \
                    -H "content-type: application/json"  \
                    -H "ce-specversion: 1.0"  \
                    -H "ce-source: /from/localhost"  \
                    -H "ce-type: eligibilityapplication" \
                    -H "ce-id: 12346"  \
                    -d "{\"age\":3,\"amount\":50000,\"bilan\":{\"gg\":5,\"ga\":2,\"hp\":1,\"hq\":2,\"dl\":50,\"ee\":2,\"siren\":\"423646512\",\"variables\":[]},\"ca\":200000,\"eligible\":false,\"msg\":\"string\",\"nbEmployees\":10,\"notation\":{\"decoupageSectoriel\":0,\"note\":\"string\",\"orientation\":\"string\",\"score\":0,\"typeAiguillage\":\"string\"},\"publicSupport\":true,\"siren\":\"423646512\",\"typeProjet\":\"IRD\"}" \
                    eligibility-loan.apps.cluster-152a.152a.sandbox1775.opentlc.com 
            ```
            The call should invoke the eligibility service that produce another event with type `noteapplication` that invoke the notation service, in fact only the eligibility service.
            both trigger for eligibility and notation services generated by the operator are using the same filter type  `kogito-incoming-stream`
            
            ```sh
                /projects/kogito-knative-loan main* ‚ùØ oc get trigger
                    NAME                            BROKER    SUBSCRIBER_URI                                     AGE     READY   REASON
                    display-all-events-ed-trigger   default   http://cloudevent-display.loan.svc.cluster.local   46h     True    
                    eligibility-listener-1203       default   http://eligibility.loan.svc.cluster.local/         23h     True    
                    loan-listener-8016              default   http://loan.loan.svc.cluster.local/                47h     True    
                    notation-listener-1762          default   http://notation.loan.svc.cluster.local/            5h11m   True    
                /projects/kogito-knative-loan main* 6s ‚ùØ oc get trigger notation-listener-1762  -o yaml  
                    apiVersion: eventing.knative.dev/v1
                    kind: Trigger
                    metadata:
                    annotations:
                        eventing.knative.dev/creator: system:serviceaccount:loan:kogito-operator-controller-manager
                        eventing.knative.dev/lastModifier: opentlc-mgr
                    creationTimestamp: 
                    generation: 2
                    labels:
                        app: notation
                        eventing.knative.dev/broker: default
                        kogito.kie.org/messageEventId: kogito_incoming_stream
                    managedFields:
                    selfLink: /apis/eventing.knative.dev/v1/namespaces/loan/triggers/notation-listener-1762
                    uid: c5446e63-1d5d-4546-b09d-4e707831afe0
                    spec:
                    broker: default
                    filter:
                        attributes:
                        type: kogito-incoming-stream
                    subscriber:
                        ref:
                        apiVersion: v1
                        kind: Service
                        name: notation
                        namespace: loan
                    status:
                    conditions:
                    observedGeneration: 2
                    subscriberUri: http://notation.loan.svc.cluster.local/ 
                ```

            the operator seems not using the eventsMeta object

            ```sh
                curl -X 'GET' \
                'http://notation-loan.apps.cluster-152a.152a.sandbox1775.opentlc.com/messaging/topics' -H 'accept: */*'
            ```

            ```json
                [
                    {
                        "name": "kogito_outgoing_stream",
                        "type": "OUTGOING",
                        "eventsMeta": [
                        {
                            "type": "process.notation.offerapplication",
                            "source": "/process/notation",
                            "kind": "PRODUCED"
                        }
                        ]
                    },
                    {
                        "name": "kogito_incoming_stream",
                        "type": "INCOMING",
                        "eventsMeta": [
                        {
                            "type": "noteapplication",
                            "source": "",
                            "kind": "CONSUMED"
                        }
                        ]
                    }
                ]
            ```

